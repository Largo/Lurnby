{% extends "base.html" %}

{% block style %}
  <link rel="stylesheet" href = "{{url_for('static', filename='style.css')}}">
  <link rel="stylesheet" href = "https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  {% endblock %}

{% block content %}
<main id="standard">
  <!-- tooltip-->
  <button id="infoDiv" type ="button" onclick = "showaddhighlightmodal()" class="tooltipDiv btn btn-dark btn-sm" >
    <span id ="addhighlight">Add Highlight</span>
  </button>

  <!-- Add Highlight Modal-->
  <div class="modal fade" id="AddHighlightModal" tabindex="-1" role="dialog" aria-labelledby="AddHighlightModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="AddHighlightModalLabel">Add highlight to topics</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form  id = "SubmitHighlightForm" action="" method="post">
             <!-- {{ form.hidden_tag() }} -->
            <input id = "article_id" type="hidden" name="article_id" value="{{ article_id}}"> 
            <div class="form-group">
              {{ form.text.label }}
              {{ form.text(class="form-control", id="HighlightField") }}
            </div>
            <br>
            <div class="form-group">
              {{ form.note.label }}
              {{ form.note(class="form-control", id="message-text") }}              
            </div>
            <div class="btn-group-toggle" data-toggle="buttons">
              {% for topic in topics %}
              <label class="button-group-pills btn btn-default">
                <input name = "topics" type="checkbox" value="{{topic.title}}">
                {{topic.title}}
              </label>
              {% endfor %}
              <span id = "topicplaceholder"></span>
          
              <span id="CreateTopic">
                <button onclick ="NewTopic()" class="create-button btn btn-success">
                  Create new topic
                </button>
              </span>
            </div>
          
        </div>
        <div class="modal-footer">
          <button type="button"  class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="SubmitHighlight()" class="btn btn-primary">Add</button>
        </div>
      </form>
      </div>
    </div>
  </div>





  <div class= "row">

    <div class="col-lg-3">
      <!-- Sidebar -->
      <nav id="sidebar">
        <!--
        <div class="sidebar-header">
              <h3><a href="{{ url_for('index' )}}">Home</a></h3>
          </div>
        -->   
        <div id ="sidebar-collapse" class = "justify-content-end ">
          <button type="button" class="btn settings-button ">
          <i id="collapse-icon" class= "fa fa-angle-double-left"></i>
          <span data-toggle="collapse" aria-expanded="false" id="inviz">Hide Controls</span>
          </button>
        </div>
        <div class="sidebar-content">

          <h6 class="sidebarheading">Set background:</h6> 
          <ul class="list-group list-group-horizontal no-style">
              <li>
                <button id = "make-light" class="list-group-item-action"> Light Mode</button>
              </li>
              <li>
                <button id = "make-dark" class="list-group-item-action"> Dark Mode</button>
              </li>
              <li>
                <button id = "make-sepia" class="list-group-item-action"> Sepia mode </button>
              </li>            
          </ul>
          <br>
          <h6 class="sidebarheading">Set font:</h6> 
          <ul class="list-group no-style d-flex justify-content-around">
              <li>
                <button id = "make-serif"><span class="font-preview">Aa </span>Serif</button>
              </li>
              <li>
                <button id = "make-sans"><span class="font-preview">Aa </span>Sans Serif</button>
              </li>    
          </ul>
          <br>
          <h6 class="sidebarheading">Set sizing:</h6> 

            <div class="d-flex align-middle sidebar-row">
              <button id="p-less"class="p-2 flex-fill make-size font-preview">-</button>
              <button class="p-2 flex-fill make-size-middle disabled">Size</button>
              <button id="p-more"class="p-2 flex-fill make-size font-preview">+</button>
            </div>
            <div class="d-flex align-middle sidebar-row">
              <button id="lheight-less"class="p-2 flex-fill make-size font-preview">-</button>
              <button class="p-2 flex-fill make-size-middle disabled">Line Height</button>
              <button id="lheight-more"class="p-2 flex-fill make-size font-preview">+</button>
            </div>
            <div class="d-flex align-middle sidebar-row">
              <button id="margin-less" class="p-2 flex-fill make-size font-preview">-</button>
              <button class="p-2 flex-fill make-size-middle disabled">Margins</button>
              <button id="margin-more" class="p-2 flex-fill make-size font-preview">+</button>
            </div>
        </div>
      </nav>
    </div>
    <div class="col-auto">
      <!-- Page Content -->
      <nav class="navbar">
      <!--
        <button type="button" id="sidebar-collapse" class="btn settings-button">
          <i id="collapse-icon" class= "fa fa-angle-double-left"></i>
          <span data-toggle="collapse" aria-expanded="false" id="inviz">Hide Controls</span>
        </button>
      -->
      </nav>
      <div id="content">
        <h1>{{ title|safe}}</h1>

        <h3>{{ author|safe}}</h3>
        <hr>
        {{ content|safe }}
      </div>

    </div>
  </div>   
</main>

{% endblock %}

{% block JS %}

<script type="text/javascript" src="{{url_for('static', filename='/texthighlighter/TextHighlighter.js')}}"></script>

<!-- My Custom JS  -->

<!-- Add sidebar js -->
<script type="text/javascript" src="{{url_for('static', filename='sidebar.js')}}"></script>

<!-- Select and highlight js. -->

<!--
<script type="text/javascript" src="{{url_for( 'static', filename='rr-selecttext.js' )}}"
-->

<script type="text/javascript" src="{{url_for( 'static', filename='highlight.js' )}}"></script>


<script type="text/javascript">
     
      var sandbox = document.getElementById('content');      
      var article_id = $("#article_id").val()

      hltr = new TextHighlighter(sandbox, {
        enabled: false,
        onAfterHighlight: function (range, highlights) {
            var serialized = hltr.serializeHighlights();
            console.log("Serialized highlights:", serialized);
            console.log("\n\n\n\n article id \n\n\n" + article_id+ "\n\n\n")

            $.post('/article/' + article_id + '/highlight-storage', {
              'SerializedHighlights': serialized
            }).done(function(response) {
              $('flashMessages').html('<div class="alert alert-success alert-dismissible fade show" role="alert">success!!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
            }).fail(function() {
              $('flashMessages').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Failure!!!!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
            });

            //window.localStorage.setItem('serializedHighlights', serialized);

          for (var i = 0; i < highlights.length; i++){
            newNode = highlights[i];
            console.log(highlights[i]);
            newNode.setAttribute('class', 'highlighted d-inline ' + returnedhighlightclass );
            newNode.setAttribute('LearnAppid', returnedhighlightid);
            //newNode.style.cssText="background-color: red !important; color: white;"
            newNode.setAttribute('tabindex', '0');
            newNode.setAttribute('data-toggle','popover' );
            newNode.setAttribute('data-container','body' );
            newNode.setAttribute('data-placement','right' );
            newNode.setAttribute('data-trigger','focus' );
            newNode.setAttribute('title','OPTIONS' );
            newNode.setAttribute('data-content','This will offer some options for what to do with a past highlight.' );
          }

          $(function () {
            $('[data-toggle="popover"]').popover()
          });

          $('.popover-dismiss').popover({
            trigger: 'focus'
          });

          var $window = $(window);
          console.log($window.scrollTop()) 
          localStorage.setItem('scrollPosition', $window.scrollTop());
          console.log('stored position: ' + localStorage.getItem('scrollPosition'))



        } 
        
      });
    

      //var serialized = window.localStorage.getItem('serializedHighlights');
      var serialized; 
      $.get('/article/' + article_id + '/highlight-storage', function(data) {
        serialized = data['SerializedHighlights']
        hltr.deserializeHighlights(serialized);
        $(function () {
        $('[data-toggle="popover"]').popover()
      })

      $('.popover-dismiss').popover({
        trigger: 'focus'
      })
      });
      
      //window.scroll(0, localStorage.getItem('scrollPosition')|0)
      $( window ).on( "load", function() { 
        var $window = $(window)
        if (localStorage.getItem('scrollPosition')){
        $window.scrollTop(localStorage.getItem('scrollPosition'))
      }

      })
      

      

</script>

<script>

  function SubmitHighlight(){
    $("#SubmitHighlightForm").ajaxSubmit({
      url: '/article/addhighlight', 
      type: 'post',
      success: function(responseText){ AddedHighlight(responseText) },
      error: function(){ FailedToAddHighlight() }
    })
  }

  var returnedhighlightid;
  var returnedhighlightclass;

  function AddedHighlight(responseText){
    
    $('#AddHighlightModal').modal('hide');
    
    /* THIS RESETS THE SUBMIT HIGHLIGHT FORM */
    document.getElementById('SubmitHighlightForm').reset()
    var c = document.querySelectorAll('input[type="checkbox"]');
    var count = c.length
    console.log(c)
    
    for (var i = 0; i < c.length; i++){
      if (c[i].parentNode.classList.contains('active')){
        c[i].click()
      }  
    }
    /* END RESET */



    selectedObj.removeAllRanges();
    selectedObj.addRange(selectedText);
    returnedhighlightclass = "highlight"+responseText['highlight_id']
    returnedhighlightid = responseText['highlight_id']
    hltr.enable();
    hltr.doHighlight();
    hltr.disable();
    
  }
    
  function FailedToAddHighlight(){
    var node = document.createElement('span');
    node.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">FAIL!!!</div>')
    document.body.appendChild(node);
    //document.body.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">FAIL!!!</div>')
  }


    


  function NewTopic(){
    $('#CreateTopic').html('<br> <div class = "form-row align-items-center"> <div class="col-sm-6 my-1"> {{ addtopicform.title(class="form-control", id ="addtopicinput", placeholder="Topic title...", required=true, autofocus=true)}} </div> <div class="col-auto my-1"> <button type="button" onclick="CancelNewTopic()" class="btn btn-outline-secondary">cancel</button> </div>  <div class="col-auto my-1"> <button onclick="NewTopicSubmit()" type="submit" class="btn btn-primary">add</button> </div> </div> </form>');
    $('#addtopicinput').trigger('focus');
  }

  
  function NewTopicSubmit(){
    $.post('/topics/add', {
      title: $('#addtopicinput').val()
    }).done(function(response) {
        $('#topicplaceholder').append('<label id="label' + response['id']+ '" class="button-group-pills btn btn-default"><input name = "topics" value = "'+response["title"]+'"type="checkbox">'+response["title"]+'</label>');
        document.getElementById("label"+response['id']).click();
        $('#CreateTopic').html('<button onclick ="NewTopic()" class="create-button btn btn-success">Create new topic </button>');
        highlightSelection();
    }).fail(function() {
        $('#CreateTopic').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">There is already a topic with that title.<button onclick = "NewTopic()" type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
    });
}


  function CancelNewTopic(){
    $('#CreateTopic').html('<button onclick ="NewTopic()" class="create-button btn btn-success">Create new topic </button>')
  }
  


</script>

{% endblock %}