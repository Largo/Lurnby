{% extends 'base.html' %}
{% block style %}
<style>
    #container {
        padding-top: 32px;
    }
    .review-item {
        max-width: 800px;
        margin: 16px 0 32px 0;
    }

    .review-header {
        background-color:white;
        padding: 16px;
    }

    .review-content {
        background-color: white;
        padding: 0 16px;
    }

    .review-actions button{
        margin-bottom: 8px;
        margin-left: 0;
    }


    .topic {
        font-weight: 100;
        font-size: 0.8rem;
        padding: 4px 8px;
        display: inline-block;
        text-align: center;
        background: #FFF79F;
        margin: 0px 4px 4px 0px;

    }
    .topic.filter:hover {
        cursor: pointer;
        color: white;
        background-color: black;
    }


    .autocomplete {
        /*the container must be positioned relative:*/
        position: relative;
        display: inline-block;
    }
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        /*position the autocomplete items to be the same width as the container:*/
        top: 100%;
        left: 0;
        right: 0;
    }
    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }
    .autocomplete-items div:hover {
        /*when hovering an item:*/
        background-color: #e9e9e9;
    }
    .autocomplete-active {
        /*when navigating through the items using the arrow keys:*/
        background-color: DodgerBlue !important;
        color: #ffffff;
    }
    
    .filter_form {
        display: flex;
        flex-wrap: wrap;
        margin: 8px;
    }

    .filter_form input, {
        padding-left: 4px;
        padding-bottom: 4px;
        width: 200px;
    }

    .filter_form select{
        margin-left: 8px;
        background-color: white;
        border: grey 0.5px solid;
        border-radius: 5%;
    }


    @media (max-width: 566px){
        #export {
            margin-top: 16px;
        }

        #export .main-button{
          margin-left: 0px;
          margin-right: 16px;
        }
    }

</style>
{% endblock %}


{% block content%}
<div id="container">
    {% if empty %}
    <div class="main-section lurnby-empty-row">
        <div class=" lurnby-empty-col col text-center">
            <span style="cursor: pointer;" onclick="rrtoggle()"><img id="rrface" class="mb-4"
                src="{{url_for('static', filename='rrbetterface2.png')}}" alt="" height="100"></span>
            <h1 id="rrtitle" class="h3 mb-3 font-weight-normal">You don't have any highlights to review!</h1>
            <p>Ever tried, ever failed, no matter,<br> try again, fail again, fail better.<br>Samuel Beckett</p>
                <a href = "{{url_for('main.articles')}}" class="main-button articles-empty-cta add-new">Read an article.</a>
        </div>
    </div>
    {% else %}
    
    

    <div id="filters" class="main-section">
        <div id="active_filters"></div>
        <div class="autocomplete">
            <div class="filter_form" >
                <input id = "filter_input" type="text" placeholder="Filter by topic ..."> <button class="main-button" onclick="apply_filters()">Apply filter</button>
            </div>
        </div>
        <div class="filter_form">
            <label for="review_count">Highlights per tier: </label>
            <select name = "review_count" id = "review_count"> 
                <option value=3> 3</option>
                <option value=5> 5</option>
                <option value=10> 10</option>
                <option value=15> 15</option>
                <option value=20> 20</option>
            </select>
        </div>
    </div>
    <div id= "review_section" class = "main-section">
        {% for tier in range(8) %}
        <div id="tier{{tier}}" class="tier">
        {% if tiers[tier]|length > 0 %}
            <div class="heading">
                <h6>Review tier {{tier}}</h6>
            </div>
            <h6 class = "subheading">{{days[tier]}} since last review</h6>
            {% for number in range(tiers[tier]|length) %}
            {% set highlight = tiers[tier][number] %}
            <div id="highlight-{{highlight.id}}" class="review-item">
                <div class="review-header">
                    <h6>From: {{ highlight.article.title}}</h6>
                    <div class="underline"></div>
                </div>
                <div class="review-content">
                    <p>{{highlight.text}}</p>
                    <div id ="highlight-{{highlight.id}}-actions" class="review-actions">
                        <button class="main-button view_highlight" onclick="ViewHighlight({{ highlight.id }})">View Details</button>
                        <button class=" main-button dont-remember" onclick="didnt_remember({{highlight.id}})">I didn't remember</button>
                        <button class="main-button remember" onclick="RaiseTier({{highlight.id}})">I remembered</button>
                    </div>
                </div>
            </div>       
            {% endfor %} 
        {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- View Highlight Modal-->
    <div class="modal" id="ViewHighlightModal" tabindex="-1" role="dialog" aria-labelledby="ViewHighlightModalLabel" aria-hidden="true">
    </div>
</div>

{% endblock%}

{% block JS %}
<script type="text/javascript" src="{{url_for( 'static', filename='js/autocomplete.js' )}}"></script>
<script type="text/javascript" src="{{url_for( 'static', filename='updatehighlight.js' )}}"></script>
<script type="text/javascript" src="{{url_for( 'static', filename='tag.js' )}}"></script>
<script type="text/javascript" src="{{url_for( 'static', filename='topic.js' )}}"></script>

<script>
review_count = byId('review_count')
review_count.value = {{current_user.review_count}} 

review_count.addEventListener('change', function(){
    url = '/review/settings'
    data = {
        'count': this.value
    }
    data = JSON.stringify(data)
    const headers = new Headers({
        'X-CSRF-TOKEN': csrf_token
    })
    fetch(url, {
        method: 'POST',
        headers,
        body: data

    })
    .then(function(response){
        if(response.ok){
            location.reload()
        }
    })
})


function ShowViewHighlightModal(id){
    url = '/view_highlight/' + id
    fetch(url)
    .then(response => response.json())
    .then(data => {
        $('#ViewHighlightModal').html(data['html']);
        add_span = byId('new-topic');
        add = byId('add_new_tag');
        initialize();
        initialize_view_topics();
        $('#ViewHighlightModal').modal('toggle')
    });

}



// function ArchiveHighlight(id){
//     byId(`highlight-${id}`).style.display = 'none'
//     console.log('highlight hidden')
    
//     url = 'archivehighlight/'+id
//     $.get(url)
//     .done(function(){
//         byId('flashMessages').innerHTML=`
//         <div class="alert alert-danger alert-dismissible fade show" role="alert">
//         <ul>
//         <li>
//             Highlight has been deleted. <button type="button" data-dismiss="alert" onclick="UnarchiveHighlight(${id})"class="main-button save cancel">UNDO</button>
//         </li>
//         </ul>
//         <button type="button" class="close" data-dismiss="alert" aria-label="Close">
//           <span aria-hidden="true">&times;</span>
//         </button>
//       </div>
//       `
//     });
    
// }

// function UnarchiveHighlight(id){
//     byId(`highlight-${id}`).style.display = 'none'
//     console.log('highlight hidden')
    
//     url = 'unarchivehighlight/'+id
//     $.get(url)
//     .done(function(){
//         byId(`highlight-${id}`).style.display = 'block'

//         byId('flashMessages').innerHTML=`
//         <div class="alert alert-success alert-dismissible fade show" role="alert">
//         <ul>
//         <li>
//             Highlight has been unarchived.
//         </li>
//         </ul>
//         <button type="button" class="close" data-dismiss="alert" aria-label="Close">
//           <span aria-hidden="true">&times;</span>
//         </button>
//       </div>
//       `
//     });
    
// }



// function UpdateHighlight(id){
//     $('#ViewHighlightModal').modal('hide')

//     var doc_tags,tags,untags, doc_topics, topics, untopics, notes, highlight, topicspace

//     notes = byId('view_highlight_notes').value
//     highlight = byId('view_highlight_text').value

//     doc_tags= byClass('update-highlight')
//     tags=[]
//     untags=[]
//     for (var i = 0; i < doc_tags.length; i++){
//         if(doc_tags[i].classList.contains('tagged')){
//             tags.push(doc_tags[i].firstElementChild.value);
//         }
//         else {
//             untags.push(doc_tags[i].firstElementChild.value);
//         }
//     }

//     doc_topics = byClass('upd-topic-label')
//     topics=[]
//     untopics=[]

//     for (var i = 0; i < doc_topics.length; i++){

//         console.log(i)
//         console.log(doc_topics[i].firstElementChild.value)
//         console.log('\n')
        
//         if (doc_topics[i].classList.contains('active')){
//             topics.push(doc_topics[i].firstElementChild.value);
//         }
//         else {
//             untopics.push(doc_topics[i].firstElementChild.value);
//         }
//     }

//     var a_tags = byClass('active-tags')
//     var a_topics = byClass('active-topics')

//     atags = []
//     atopics = []

//     for (var i=0;i<a_tags.length;i++){
//     atags.push(a_tags[i].firstElementChild.value)
//     }

//     for (var i=0;i<a_topics.length;i++){
//     atopics.push(a_topics[i].firstElementChild.value)
//     }

//     topicspace = byId('topics_all')
//     if (topicspace){
//         data = {
//             'notes': notes,
//             'highlight':highlight,
//             'topics':topics,
//             'untopics':untopics,
//             'tags':tags,
//             'untags':untags,
//             'atags':atags,
//             'atopics':atopics,
//             'topics-page':'true'
//         }
//     }
//     else {
//         data = {
//             'notes': notes,
//             'highlight':highlight,
//             'topics':topics,
//             'untopics':untopics,
//             'tags':tags,
//             'untags':untags,
//             'atags':false,
//             'atopics':false,
//             'topics-page':'false',
//             'do_not_review': byId('do_not_review').checked
//         }
//     }

//     data = JSON.stringify(data)
//     console.log(data)
    
//     url = '/view_highlight/' + id
//     topicspace = byId('topics_all')
//         if (topicspace){
//             topicspace.innerHTML=`
//                 <div class = "loading">
//                     <p>Loading...</p>
//                     <svg xmlns="http://www.w3.org/2000/svg" style="margin:auto;background:0 0" width="64" height="64" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" display="block"><circle cx="50" cy="50" fill="none" stroke="#e3e3e3" stroke-width="5" r="32" stroke-dasharray="150.79644737231007 52.26548245743669" transform="rotate(144.01 50 50)"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"/></circle></svg>
//                 </div>
//             `
//         }
        
//     $.post(url, {
//         'data':data
//     }).done(function( data ) {
//         if (topicspace){
//             topicspace.innerHTML = data;
//             initialize();
//             console.log(data)
//         }
//     }); 
// }

function reviewed_all(){
    var container = byId('container')
    var data = `
    <div class="main-section lurnby-empty-row">
        <div class=" lurnby-empty-col col text-center">
            <span style="cursor: pointer;" onclick="rrtoggle()"><img id="rrface" class="mb-4"
                src="{{url_for('static', filename='rr-100.png')}}" alt="" height="100"></span>
            <h1 id="rrtitle" class="h3 mb-3 font-weight-normal">All done for now!</h1>
                <p>Great work. Check back later for more review items.</p>
                <a href = "{{url_for('main.review')}}" class="main-button articles-empty-cta add-new">Review more now</a>
        </div>
    </div>
    `
    container.innerHTML = data

}

function didnt_remember(id){

    var actions = byId('highlight-'+ id + '-actions')
    actions.innerHTML = `<button class=" main-button" onclick="LowerTier(${id})">Review sooner</button> <button class=" main-button" onclick="KeepTier(${id})">Review regularly</button> <button class=" main-button" onclick="goBack(${id})">Back</button>`

}

function goBack(id){
    var actions = byId('highlight-'+ id + '-actions')
    actions.innerHTML = `<button class="main-button view_highlight" onclick="ViewHighlight(${id})">View Details</button>
                        <button class=" main-button dont-remember" onclick="didnt_remember(${id})">I didn't remember</button>
                        <button class="main-button remember" onclick="RaiseTier(${id})">I remembered</button>`
}

function RaiseTier(id){
    var reviewitem = byId('highlight-'+id)
    reviewitem.remove()
    if (byClass('review-item').length == 0) {
        reviewed_all()
    }
    url = '/tier/' + id
    data = {
        'tier': 'raise'
    }

    $.post(url, {
        'data': JSON.stringify(data)
    })

}

function LowerTier(id){
    var reviewitem = byId('highlight-'+id)
    reviewitem.remove()
    if (byClass('review-item').length == 0) {
        reviewed_all()
    }
    url = '/tier/' + id
    data = {
        'tier': 'lower'
    }

    $.post(url, {
        'data': JSON.stringify(data)
    })

}

function KeepTier(id){
    var reviewitem = byId('highlight-'+id)
    reviewitem.remove()
    if (byClass('review-item').length == 0) {
        reviewed_all()
    }

    url = '/tier/' + id
    data = {
        'tier': 'keep'
    }

    $.post(url, {
        'data': JSON.stringify(data)
    })
}

var topics = [ {% for t in topics %}'{{t.title}}',{%endfor%}]
    active_filters = byId('active_filters')
    var filters = []

    autocomplete(document.getElementById("filter_input"), topics, byId('active_filters'), create=false, 'filterhighlight');

    function apply_filters(){
        filters=[]
        Array.from(byClass('filter_highlight_member')).forEach(t => filters.push(t.innerText))
        data = JSON.stringify({'filters':filters})

        var a = byId('review_section');
        a.innerHTML = `<div style = "display: block; text-align:center; float:center; margin:auto; margin-top: 88px; padding:88px; background: white; border:black 2px solid; width: 500px;">
                            <p>Getting your highlights now ...</p>
                            <img src="static/spinning-circles.svg" width="50" alt="">
                       </div>`;


        $.post('/review', {
            'data':data
        }).done(function( data ) {
            data = JSON.parse(data)
            console.log(data)
            a.innerHTML = data['html']
            topics = data['topics']
            autocomplete(document.getElementById("filter_input"), topics, byId('active_filters'), create=false, 'filterhighlight');
        }); 
    }

</script>


{% endblock%}